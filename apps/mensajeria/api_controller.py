# apps/mensajeria/controllers/mensajes_controller.py
from ninja_extra import api_controller, http_post
from ninja_extra.controllers import ControllerBase
from datetime import datetime
from django.http import JsonResponse
from .schemas import MensajeHookIn
from .models import Mensaje

@api_controller("/hooks/mensajes/", tags=["Mensajes"])
class MensajesHookController(ControllerBase):

    @http_post("/recibir/", url_name="recibir_mensaje")
    def recibir_mensaje(self, request, data: MensajeHookIn):
        print("ðŸ“¥ Mensaje recibido desde Moodle:", data.dict())

        Mensaje.objects.create(
            moodle_id_remitente=data.from_user,
            moodle_id_destinatario=data.to_user,
            curso_moodle_id=data.courseid,
            contenido=data.message,
            timestamp=datetime.fromtimestamp(data.timestamp),
            enviado_por_django=False
        )

        return {"status": "ok", "mensaje": "Mensaje registrado correctamente"}














































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































